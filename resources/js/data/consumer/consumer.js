// Consumer Data with Meter Information
export const consumerData = [
    {
        cust_id: 1001,
        name: 'Juan Dela Cruz',
        address: 'Purok 1, Poblacion',
        meter_no: 'MTR-XYZ-12345',
        meter_id: 5001,
        rate: '₱25.50/m³',
        total_bill: '₱3,500.00',
        ledger_balance: '₱0.00',
        status: 'Active'
    },
    {
        cust_id: 1002,
        name: 'Maria Santos',
        address: 'Purok 2, Central',
        meter_no: 'MTR-ABC-67890',
        meter_id: 5002,
        rate: '₱25.50/m³',
        total_bill: '₱2,850.00',
        ledger_balance: '₱500.00',
        status: 'Overdue'
    },
    {
        cust_id: 1003,
        name: 'Pedro Garcia',
        address: 'Purok 3, San Jose',
        meter_no: 'MTR-DEF-11111',
        meter_id: 5003,
        rate: '₱25.50/m³',
        total_bill: '₱4,200.00',
        ledger_balance: '₱0.00',
        status: 'Active'
    },
    {
        cust_id: 1004,
        name: 'Ana Rodriguez',
        address: 'Purok 1, Poblacion',
        meter_no: 'MTR-004',
        rate: '₱25.50/m³',
        total_bill: '₱3,100.00',
        ledger_balance: '₱200.00',
        status: 'Pending'
    },
    {
        cust_id: 1005,
        name: 'Carlos Lopez',
        address: 'Purok 4, Maligaya',
        meter_no: 'MTR-005',
        rate: '₱25.50/m³',
        total_bill: '₱3,750.00',
        ledger_balance: '₱0.00',
        status: 'Active'
    },
    {
        cust_id: 1006,
        name: 'Lisa Chen',
        address: 'Purok 2, Central',
        meter_no: 'MTR-006',
        rate: '₱25.50/m³',
        total_bill: '₱2,950.00',
        ledger_balance: '₱100.00',
        status: 'Overdue'
    },
    {
        cust_id: 1007,
        name: 'Mark Johnson',
        address: 'Purok 5, San Roque',
        meter_no: 'MTR-007',
        rate: '₱25.50/m³',
        total_bill: '₱4,500.00',
        ledger_balance: '₱0.00',
        status: 'Active'
    },
    {
        cust_id: 1008,
        name: 'Sofia Martinez',
        address: 'Purok 1, Poblacion',
        meter_no: 'MTR-008',
        rate: '₱25.50/m³',
        total_bill: '₱3,300.00',
        ledger_balance: '₱300.00',
        status: 'Pending'
    },
    {
        cust_id: 1009,
        name: 'David Wilson',
        address: 'Purok 6, Dampol',
        meter_no: 'MTR-009',
        rate: '₱25.50/m³',
        total_bill: '₱3,800.00',
        ledger_balance: '₱0.00',
        status: 'Active'
    },
    {
        cust_id: 1010,
        name: 'Emma Brown',
        address: 'Purok 3, Central',
        meter_no: 'MTR-010',
        rate: '₱25.50/m³',
        total_bill: '₱2,700.00',
        ledger_balance: '₱400.00',
        status: 'Overdue'
    },
    {
        cust_id: 1011,
        name: 'Roberto Fernandez',
        address: 'Purok 7, Riverside',
        meter_no: 'MTR-011',
        rate: '₱25.50/m³',
        total_bill: '₱3,200.00',
        ledger_balance: '₱0.00',
        status: 'Active'
    },
    {
        cust_id: 1012,
        name: 'Angela Torres',
        address: 'Purok 4, Maligaya',
        meter_no: 'MTR-012',
        rate: '₱25.50/m³',
        total_bill: '₱2,900.00',
        ledger_balance: '₱150.00',
        status: 'Pending'
    },
    {
        cust_id: 1013,
        name: 'Miguel Reyes',
        address: 'Purok 8, Hillside',
        meter_no: 'MTR-013',
        rate: '₱25.50/m³',
        total_bill: '₱4,100.00',
        ledger_balance: '₱0.00',
        status: 'Active'
    },
    {
        cust_id: 1014,
        name: 'Carmen Valdez',
        address: 'Purok 2, Central',
        meter_no: 'MTR-014',
        rate: '₱25.50/m³',
        total_bill: '₱3,600.00',
        ledger_balance: '₱250.00',
        status: 'Overdue'
    },
    {
        cust_id: 1015,
        name: 'Francisco Ramos',
        address: 'Purok 9, Lakeside',
        meter_no: 'MTR-015',
        rate: '₱25.50/m³',
        total_bill: '₱3,400.00',
        ledger_balance: '₱0.00',
        status: 'Active'
    },
    {
        cust_id: 1016,
        name: 'Isabella Cruz',
        address: 'Purok 1, Poblacion',
        meter_no: 'MTR-016',
        rate: '₱25.50/m³',
        total_bill: '₱2,800.00',
        ledger_balance: '₱100.00',
        status: 'Pending'
    },
    {
        cust_id: 1017,
        name: 'Antonio Morales',
        address: 'Purok 10, Mountain View',
        meter_no: 'MTR-017',
        rate: '₱25.50/m³',
        total_bill: '₱4,300.00',
        ledger_balance: '₱0.00',
        status: 'Active'
    },
    {
        cust_id: 1018,
        name: 'Lucia Mendoza',
        address: 'Purok 5, San Roque',
        meter_no: 'MTR-018',
        rate: '₱25.50/m³',
        total_bill: '₱3,150.00',
        ledger_balance: '₱350.00',
        status: 'Overdue'
    },
    {
        cust_id: 1019,
        name: 'Gabriel Santos',
        address: 'Purok 6, Dampol',
        meter_no: 'MTR-019',
        rate: '₱25.50/m³',
        total_bill: '₱3,900.00',
        ledger_balance: '₱0.00',
        status: 'Active'
    },
    {
        cust_id: 1020,
        name: 'Valentina Diaz',
        address: 'Purok 3, San Jose',
        meter_no: 'MTR-020',
        rate: '₱25.50/m³',
        total_bill: '₱2,650.00',
        ledger_balance: '₱200.00',
        status: 'Inactive'
    }
];

// Consumer Documents Dummy Data
export const consumerDocuments = [
    {
        document_id: 1,
        cust_id: 1001,
        document_type: 'ID_PHOTO',
        file_name: 'juan_dl_front.jpg',
        file_path: '/uploads/docs/1001/juan_dl_front.jpg',
        uploaded_at: '2024-01-15 09:35:00',
        verified: 1,
        verified_by: 101,
        verified_at: '2024-01-15 14:20:00'
    },
    {
        document_id: 2,
        cust_id: 1001,
        document_type: 'ID_PHOTO',
        file_name: 'juan_dl_back.jpg',
        file_path: '/uploads/docs/1001/juan_dl_back.jpg',
        uploaded_at: '2024-01-15 09:36:00',
        verified: 1,
        verified_by: 101,
        verified_at: '2024-01-15 14:20:00'
    },
    {
        document_id: 3,
        cust_id: 1001,
        document_type: 'PROOF_OF_ADDRESS',
        file_name: 'juan_utility_bill.pdf',
        file_path: '/uploads/docs/1001/juan_utility_bill.pdf',
        uploaded_at: '2024-01-15 09:40:00',
        verified: 0,
        verified_by: null,
        verified_at: null
    },
    {
        document_id: 4,
        cust_id: 1002,
        document_type: 'ID_PHOTO',
        file_name: 'maria_passport.jpg',
        file_path: '/uploads/docs/1002/maria_passport.jpg',
        uploaded_at: '2024-01-16 10:15:00',
        verified: 1,
        verified_by: 102,
        verified_at: '2024-01-16 15:30:00'
    },
    {
        document_id: 5,
        cust_id: 1002,
        document_type: 'PROOF_OF_ADDRESS',
        file_name: 'maria_bank_statement.pdf',
        file_path: '/uploads/docs/1002/maria_bank_statement.pdf',
        uploaded_at: '2024-01-16 10:20:00',
        verified: 1,
        verified_by: 102,
        verified_at: '2024-01-16 15:30:00'
    },
    {
        document_id: 6,
        cust_id: 1003,
        document_type: 'ID_PHOTO',
        file_name: 'carlos_license_front.jpg',
        file_path: '/uploads/docs/1003/carlos_license_front.jpg',
        uploaded_at: '2024-01-17 08:45:00',
        verified: 0,
        verified_by: null,
        verified_at: null
    },
    {
        document_id: 7,
        cust_id: 1003,
        document_type: 'ID_PHOTO',
        file_name: 'carlos_license_back.jpg',
        file_path: '/uploads/docs/1003/carlos_license_back.jpg',
        uploaded_at: '2024-01-17 08:46:00',
        verified: 0,
        verified_by: null,
        verified_at: null
    },
    {
        document_id: 8,
        cust_id: 1004,
        document_type: 'BIRTH_CERTIFICATE',
        file_name: 'ana_birth_cert.pdf',
        file_path: '/uploads/docs/1004/ana_birth_cert.pdf',
        uploaded_at: '2024-01-18 11:30:00',
        verified: 1,
        verified_by: 103,
        verified_at: '2024-01-18 16:45:00'
    },
    {
        document_id: 9,
        cust_id: 1004,
        document_type: 'PROOF_OF_ADDRESS',
        file_name: 'ana_lease_agreement.pdf',
        file_path: '/uploads/docs/1004/ana_lease_agreement.pdf',
        uploaded_at: '2024-01-18 11:35:00',
        verified: 0,
        verified_by: null,
        verified_at: null
    },
    {
        document_id: 10,
        cust_id: 1005,
        document_type: 'ID_PHOTO',
        file_name: 'pedro_cedula.jpg',
        file_path: '/uploads/docs/1005/pedro_cedula.jpg',
        uploaded_at: '2024-01-19 14:20:00',
        verified: 1,
        verified_by: 101,
        verified_at: '2024-01-19 17:10:00'
    },
    {
        document_id: 11,
        cust_id: 1005,
        document_type: 'PROOF_OF_INCOME',
        file_name: 'pedro_payslip.pdf',
        file_path: '/uploads/docs/1005/pedro_payslip.pdf',
        uploaded_at: '2024-01-19 14:25:00',
        verified: 0,
        verified_by: null,
        verified_at: null
    },
    {
        document_id: 12,
        cust_id: 1006,
        document_type: 'ID_PHOTO',
        file_name: 'lucia_dni_front.jpg',
        file_path: '/uploads/docs/1006/lucia_dni_front.jpg',
        uploaded_at: '2024-01-20 09:15:00',
        verified: 1,
        verified_by: 102,
        verified_at: '2024-01-20 13:40:00'
    },
    {
        document_id: 13,
        cust_id: 1006,
        document_type: 'ID_PHOTO',
        file_name: 'lucia_dni_back.jpg',
        file_path: '/uploads/docs/1006/lucia_dni_back.jpg',
        uploaded_at: '2024-01-20 09:16:00',
        verified: 1,
        verified_by: 102,
        verified_at: '2024-01-20 13:40:00'
    },
    {
        document_id: 14,
        cust_id: 1007,
        document_type: 'PROOF_OF_ADDRESS',
        file_name: 'miguel_electric_bill.pdf',
        file_path: '/uploads/docs/1007/miguel_electric_bill.pdf',
        uploaded_at: '2024-01-21 16:30:00',
        verified: 0,
        verified_by: null,
        verified_at: null
    },
    {
        document_id: 15,
        cust_id: 1008,
        document_type: 'ID_PHOTO',
        file_name: 'sofia_passport.jpg',
        file_path: '/uploads/docs/1008/sofia_passport.jpg',
        uploaded_at: '2024-01-22 12:45:00',
        verified: 1,
        verified_by: 103,
        verified_at: '2024-01-22 18:20:00'
    }
];

// Document types for reference
export const documentTypes = [
    'ID_PHOTO',
    'PROOF_OF_ADDRESS',
    'BIRTH_CERTIFICATE',
    'PROOF_OF_INCOME',
    'UTILITY_BILL',
    'BANK_STATEMENT',
    'LEASE_AGREEMENT'
];

// Verification status options
export const verificationStatus = {
    0: 'Pending',
    1: 'Verified'
};

// Consumer Management Functions
export class ConsumerManager {
    constructor() {
        this.consumers = consumerData;
        this.filteredConsumers = [...this.consumers];
        this.currentPage = 1;
        this.itemsPerPage = 10;
    }

    filterConsumers(searchTerm = '', statusFilter = '') {
        this.filteredConsumers = this.consumers.filter(consumer => {
            const matchesSearch = !searchTerm ||
                consumer.cust_id.toString().includes(searchTerm.toLowerCase()) ||
                consumer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                consumer.address.toLowerCase().includes(searchTerm.toLowerCase()) ||
                consumer.meter_no.toLowerCase().includes(searchTerm.toLowerCase());

            const matchesStatus = !statusFilter || consumer.status.toLowerCase() === statusFilter.toLowerCase();

            return matchesSearch && matchesStatus;
        });
        this.currentPage = 1;
    }

    getPageData() {
        const startIndex = (this.currentPage - 1) * this.itemsPerPage;
        const endIndex = startIndex + this.itemsPerPage;
        return this.filteredConsumers.slice(startIndex, endIndex);
    }

    getStatusColor(status) {
        const colors = {
            'Active': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300',
            'Pending': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300',
            'Overdue': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300',
            'Inactive': 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300'
        };
        return colors[status] || 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300';
    }

    getConsumerById(custId) {
        return this.consumers.find(c => c.cust_id == custId);
    }
}

// Workflow History Data
export const workflowHistory = [
    { history_id: 'H001', from_status: 'PENDING', to_status: 'DOCUMENTS_SUBMITTED', action: 'Documents Upload', performed_by: 'System', performed_at: '2024-01-15 09:35:00', notes: 'Customer uploaded required documents' },
    { history_id: 'H002', from_status: 'DOCUMENTS_SUBMITTED', to_status: 'UNDER_REVIEW', action: 'Review Started', performed_by: 'Admin User', performed_at: '2024-01-15 10:00:00', notes: 'Documents under review by admin' },
    { history_id: 'H003', from_status: 'UNDER_REVIEW', to_status: 'APPROVED', action: 'Application Approved', performed_by: 'Admin User', performed_at: '2024-01-15 14:20:00', notes: 'All documents verified and approved' },
    { history_id: 'H004', from_status: 'APPROVED', to_status: 'METER_ASSIGNED', action: 'Meter Assignment', performed_by: 'Technician', performed_at: '2024-01-16 08:30:00', notes: 'Meter MTR-001 assigned to customer' },
    { history_id: 'H005', from_status: 'METER_ASSIGNED', to_status: 'ACTIVE', action: 'Service Activated', performed_by: 'System', performed_at: '2024-01-16 10:00:00', notes: 'Water service activated successfully' }
];

// Make data available globally
if (typeof window !== 'undefined') {
    window.consumerData = consumerData;
    window.consumerDocuments = consumerDocuments;
    window.workflowHistory = workflowHistory;
    window.ConsumerManager = ConsumerManager;
    
    // Load consumers from localStorage (from completed connections)
    const storedConsumers = JSON.parse(localStorage.getItem('consumerList') || '[]');
    
    // Merge stored consumers with existing data
    const mergedConsumers = [...consumerData];
    storedConsumers.forEach(stored => {
        if (!mergedConsumers.find(c => c.cust_id === stored.customer_code)) {
            mergedConsumers.push({
                cust_id: stored.customer_code,
                name: stored.customer_name,
                address: stored.address || 'N/A',
                meter_no: stored.meter_id || 'N/A',
                meter_id: stored.meter_id,
                rate: '₱25.50/m³',
                total_bill: '₱0.00',
                ledger_balance: '₱0.00',
                status: stored.status || 'Active'
            });
        }
    });
    
    window.consumerData = mergedConsumers;
    
    // Also make consumer data available in the same format as meter data expects
    window.consumerList = mergedConsumers.map(consumer => ({
        connection_id: `CON-${consumer.cust_id.toString().padStart(3, '0')}`,
        consumer_name: consumer.name,
        account_no: `ACC-${consumer.cust_id}`,
        address: consumer.address,
        service_type: 'Residential',
        connection_date: '2024-01-15'
    }));
}

let consumerManager;
let consumerId;
let documentsData = [];
let historyData = [];

document.addEventListener('DOMContentLoaded', function() {
    // Initialize consumer list if on consumer list page
    if (document.getElementById('consumer-documents-table')) {
        initConsumerList();
    }
    
    // Initialize consumer details if on consumer details page
    if (document.getElementById('consumer-id')) {
        consumerManager = new ConsumerManager();
        consumerId = window.location.pathname.split('/').pop();
        initializeConsumerDetails();
    }
});

    function initializeConsumerDetails() {
        const consumer = consumerManager.getConsumerById(consumerId);
        if (consumer) {
            loadConsumerInfo(consumer);
        }

        // Load documents and history
        documentsData = window.consumerDocuments?.filter(doc => doc.cust_id == consumerId) || [];
        historyData = window.workflowHistory || [];

        renderDocuments();
        renderHistory();
    }

    function loadConsumerInfo(consumer) {
        document.getElementById('consumer-id').textContent = consumer.cust_id;
        document.getElementById('consumer-name').textContent = consumer.name;
        document.getElementById('consumer-address').textContent = consumer.address;
        document.getElementById('consumer-meter').textContent = consumer.meter_no;
        document.getElementById('consumer-rate').textContent = consumer.rate;
        document.getElementById('consumer-bill').textContent = consumer.total_bill;
        document.getElementById('consumer-ledger').textContent = consumer.ledger_balance;

        const statusElement = document.getElementById('consumer-status');
        statusElement.textContent = consumer.status;
        statusElement.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${consumerManager.getStatusColor(consumer.status)}`;
    }

function switchTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.className = 'tab-button border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300';
    });
    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

    if (tab === 'documents') {
        document.getElementById('tab-documents').className = 'tab-button border-b-2 border-blue-500 py-4 px-1 text-sm font-medium text-blue-600 dark:text-blue-400';
        document.getElementById('documents-content').classList.remove('hidden');
    } else if (tab === 'history') {
        document.getElementById('tab-history').className = 'tab-button border-b-2 border-blue-500 py-4 px-1 text-sm font-medium text-blue-600 dark:text-blue-400';
        document.getElementById('history-content').classList.remove('hidden');
    }
}

// Make functions globally available
window.switchTab = switchTab;

function renderDocuments() {
    const tbody = document.getElementById('documents-tbody');
    if (!tbody || !documentsData) return;
    
    tbody.innerHTML = documentsData.map(doc => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <td class="px-4 py-3 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                    ${doc.document_type.replace(/_/g, ' ')}
                </span>
            </td>
            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">${doc.file_name}</td>
            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">${new Date(doc.uploaded_at).toLocaleDateString()}</td>
            <td class="px-4 py-3 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${doc.verified ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200'}">
                    ${doc.verified ? 'Verified' : 'Pending'}
                </span>
            </td>
            <td class="px-4 py-3 text-center">
                <button class="text-blue-600 hover:text-blue-900 dark:text-blue-400 mr-2" title="View">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="text-purple-600 hover:text-purple-900 dark:text-purple-400" title="Download">
                    <i class="fas fa-download"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function renderHistory() {
    const tbody = document.getElementById('history-tbody');
    if (!tbody || !historyData) return;
    
    tbody.innerHTML = historyData.map(history => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <td class="px-4 py-3 text-sm font-mono text-gray-900 dark:text-gray-100">${history.history_id}</td>
            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">${history.from_status}</td>
            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">${history.to_status}</td>
            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">${history.action}</td>
            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">${history.performed_by}</td>
            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">${new Date(history.performed_at).toLocaleString()}</td>
            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">${history.notes}</td>
        </tr>
    `).join('');
}

function initConsumerList() {
    consumerManager = new ConsumerManager();
    renderTable();
    bindEvents();
    updatePagination();
}

function bindEvents() {
    const searchInput = document.getElementById('consumer-search');
    const filterSelect = document.getElementById('verification-filter');
    
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const statusFilter = filterSelect ? filterSelect.value : '';
            consumerManager.filterConsumers(searchTerm, statusFilter);
            renderTable();
            updatePagination();
        });
    }

    if (filterSelect) {
        filterSelect.addEventListener('change', (e) => {
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const statusFilter = e.target.value;
            consumerManager.filterConsumers(searchTerm, statusFilter);
            renderTable();
            updatePagination();
        });
    }
}

function updatePagination() {
    const totalPages = Math.ceil(consumerManager.filteredConsumers.length / consumerManager.itemsPerPage) || 1;
    const start = Math.min(((consumerManager.currentPage - 1) * consumerManager.itemsPerPage) + 1, consumerManager.filteredConsumers.length);
    const end = Math.min(consumerManager.currentPage * consumerManager.itemsPerPage, consumerManager.filteredConsumers.length);
    
    document.getElementById('consumerCurrentPage').textContent = consumerManager.currentPage;
    document.getElementById('consumerTotalPages').textContent = totalPages;
    document.getElementById('consumerTotalRecords').textContent = `${start} to ${end} of ${consumerManager.filteredConsumers.length}`;
    
    const prevBtn = document.getElementById('consumerPrevBtn');
    const nextBtn = document.getElementById('consumerNextBtn');
    
    if (prevBtn) prevBtn.disabled = consumerManager.currentPage === 1;
    if (nextBtn) nextBtn.disabled = consumerManager.currentPage >= totalPages;
}

window.consumerPagination = {
    prevPage: function() {
        if (consumerManager.currentPage > 1) {
            consumerManager.currentPage--;
            renderTable();
            updatePagination();
        }
    },
    nextPage: function() {
        const totalPages = Math.ceil(consumerManager.filteredConsumers.length / consumerManager.itemsPerPage);
        if (consumerManager.currentPage < totalPages) {
            consumerManager.currentPage++;
            renderTable();
            updatePagination();
        }
    },
    updatePageSize: function(newSize) {
        consumerManager.itemsPerPage = parseInt(newSize) || 10;
        consumerManager.currentPage = 1;
        renderTable();
        updatePagination();
    }
};

function renderTable() {
    const tbody = document.getElementById('consumer-documents-tbody');
    if (!tbody || !consumerManager) return;
    
    const pageConsumers = consumerManager.getPageData();

    tbody.innerHTML = pageConsumers.map(consumer => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <td class="px-4 py-3">
                <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-green-600 dark:text-green-400"></i>
                    </div>
                    <div class="ml-3">
                        <div class="text-sm font-medium text-gray-900 dark:text-gray-100">${consumer.name}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 font-mono">${consumer.cust_id}</div>
                    </div>
                </div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">
                <i class="fas fa-map-marker-alt mr-1 text-gray-400"></i>${consumer.address}
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-sm font-mono text-gray-900 dark:text-gray-100">
                ${consumer.meter_no}
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-right font-bold text-gray-900 dark:text-gray-100">
                ${consumer.total_bill}
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-center">
                <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full ${consumerManager.getStatusColor(consumer.status)}">
                    <i class="fas fa-${consumer.status === 'Active' ? 'check-circle' : consumer.status === 'Overdue' ? 'exclamation-circle' : 'clock'} mr-1"></i>
                    ${consumer.status}
                </span>
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-center">
                <div class="flex items-center justify-center space-x-2">
                    <button onclick="viewConsumer(${consumer.cust_id})"
                        class="text-blue-600 hover:text-blue-900 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 p-2 rounded transition-colors"
                        title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <div class="relative inline-block text-left">
                        <button onclick="toggleDropdown(${consumer.cust_id})"
                            class="text-gray-600 hover:text-gray-900 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-900/20 p-2 rounded transition-colors"
                            title="More Actions">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div id="dropdown-${consumer.cust_id}" class="hidden absolute right-0 z-10 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg ring-1 ring-black ring-opacity-5">
                            <div class="py-1">
                                <a href="/meter/management?consumer=${consumer.cust_id}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-tachometer-alt mr-2"></i>Meter
                                </a>
                                <a href="/rate/management?consumer=${consumer.cust_id}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-percentage mr-2"></i>Rate
                                </a>
                                <a href="/ledger/management?consumer=${consumer.cust_id}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-book mr-2"></i>Ledger
                                </a>
                                <a href="/billing/management?consumer=${consumer.cust_id}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-file-invoice-dollar mr-2"></i>Bill
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
    `).join('');
}

    // Global functions for actions
    window.viewConsumer = function(custId) {
        window.location.href = `/consumer/details/${custId}`;
    };

    window.toggleDropdown = function(custId) {
        const dropdown = document.getElementById(`dropdown-${custId}`);
        // Close all other dropdowns
        document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
            if (d.id !== `dropdown-${custId}`) d.classList.add('hidden');
        });
        dropdown.classList.toggle('hidden');
    };

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('[onclick^="toggleDropdown"]')) {
            document.querySelectorAll('[id^="dropdown-"]').forEach(d => d.classList.add('hidden'));
        }
    });
    
    // Export functions
    window.exportPDF = function() {
        console.log('Exporting to PDF...');
        alert('PDF export functionality - Coming soon!');
    };
    
    window.exportExcel = function() {
        console.log('Exporting to Excel...');
        alert('Excel export functionality - Coming soon!');
    };
    
    window.filterConsumers = function() {
        const searchTerm = document.getElementById('consumer-search')?.value.toLowerCase() || '';
        const statusFilter = document.getElementById('verification-filter')?.value || '';
        consumerManager.filterConsumers(searchTerm, statusFilter);
        renderTable();
    };
